#!/bin/bash
set -euo pipefail

# === Variables ===
AGENT_USER="ubuntu"
AGENT_HOME="/home/${AGENT_USER}"
AGENT_DIR="${AGENT_HOME}/agentsystem"
REPO_URL="https://github.com/Nawak05/agentsystem"
NODE_BIN="/usr/bin/node"   # v√©rifier chemin node (node -v pour tester)

# === V√©rifie que l'utilisateur existe ===
if ! id "${AGENT_USER}" >/dev/null 2>&1; then
    echo "Cr√©ation de l'utilisateur ${AGENT_USER}..."
    sudo useradd -m "${AGENT_USER}"
    echo "${AGENT_USER} ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/${AGENT_USER}
fi

# Aller dans le home de ubuntu
cd "${AGENT_HOME}" || { echo "Impossible d'acc√©der √† ${AGENT_HOME}"; exit 1; }

# Supprimer ancien dossier agentsystem
if [ -d "${AGENT_DIR}" ]; then
    echo "Suppression de l'ancien dossier ${AGENT_DIR}..."
    sudo rm -rf "${AGENT_DIR}"
fi

# Cloner le d√©p√¥t
echo "üì¶ Clonage du d√©p√¥t GitHub..."
sudo -u "${AGENT_USER}" git clone "${REPO_URL}" "${AGENT_DIR}" || { echo "‚ùå √âchec du clone"; exit 1; }

# Aller dans le dossier et installer npm deps en tant qu'ubuntu
echo "üì¶ Installation des d√©pendances npm..."
cd "${AGENT_DIR}" || exit 1
sudo -u "${AGENT_USER}" bash -lc "npm install --no-audit --no-fund" || { echo "‚ùå √âchec npm install"; exit 1; }

# Assurer la bonne propri√©t√©
sudo chown -R "${AGENT_USER}:${AGENT_USER}" "${AGENT_DIR}"

# Cr√©ation de la cl√© SSH (optionnel) dans /home/ubuntu/.ssh
SSH_DIR="${AGENT_HOME}/.ssh"
AGENT_KEY="${SSH_DIR}/id_ed25519_agent"
sudo -u "${AGENT_USER}" mkdir -p "${SSH_DIR}"
sudo chmod 700 "${SSH_DIR}"

if [ ! -f "${AGENT_KEY}" ]; then
    echo "üîë G√©n√©ration de la cl√© SSH pour ${AGENT_USER}..."
    sudo -u "${AGENT_USER}" ssh-keygen -t ed25519 -f "${AGENT_KEY}" -N "" -C "agent_system_key"
fi

# Ajouter la cl√© publique √† authorized_keys (et fixer propri√©taire)
AUTHORIZED_KEYS="${SSH_DIR}/authorized_keys"
sudo -u "${AGENT_USER}" touch "${AUTHORIZED_KEYS}"
sudo chmod 600 "${AUTHORIZED_KEYS}"
PUB_KEY_CONTENT=$(sudo -u "${AGENT_USER}" cat "${AGENT_KEY}.pub")
# append if not present
sudo -u "${AGENT_USER}" bash -lc "grep -qxF '${PUB_KEY_CONTENT}' '${AUTHORIZED_KEYS}' || echo '${PUB_KEY_CONTENT}' >> '${AUTHORIZED_KEYS}'"

# Fix permissions (owner ubuntu)
sudo chown -R "${AGENT_USER}:${AGENT_USER}" "${SSH_DIR}"

echo "‚úÖ Agent install√© dans ${AGENT_HOME}"
echo "Prochaine √©tape : cr√©er/installer le service systemd (optionnel mais recommand√©)."
