#!/bin/bash
set -euo pipefail

# === CONFIG ===
AGENT_USER="ubuntu"                       # user to run agent (common on OVH)
AGENT_HOME="/home/${AGENT_USER}"
AGENT_DIR="${AGENT_HOME}/agentsystem"
REPO_URL="https://github.com/Nawak05/agentsystem"
SUDOERS_FILE="/etc/sudoers.d/agent-usr"

# Liste des commandes qu'on autorise pour l'agent via sudo (NOPASSWD)
# Ajuste si nÃ©cessaire : garder minimal pour limiter les risques.
ALLOWED_CMDS=(
  "/usr/bin/apt"
  "/usr/bin/apt-get"
  "/bin/systemctl"
  "/usr/bin/mysql"
  "/usr/bin/mysqladmin"
  "/bin/cp"
  "/bin/chown"
  "/bin/chmod"
  "/bin/mkdir"
  "/bin/rm"
  "/bin/tar"
  "/usr/bin/git"
  "/usr/bin/wget"
  "/usr/bin/curl"
)

echo "ðŸš€ Setup UniversellHub Agent - $(date)"

# === 0) PrÃ©-requis: Ãªtre root (script doit Ãªtre lancÃ© via sudo) ===
if [[ "$(id -u)" -ne 0 ]]; then
  echo "ERREUR: ce script doit Ãªtre lancÃ© en root ou via sudo."
  exit 1
fi

# === 1) VÃ©rifier/CrÃ©er utilisateur si besoin ===
if id "${AGENT_USER}" >/dev/null 2>&1; then
  echo "ðŸ‘¤ Utilisateur ${AGENT_USER} existe dÃ©jÃ ."
else
  echo "âž• CrÃ©ation de l'utilisateur ${AGENT_USER} (sans mot de passe)..."
  adduser --disabled-password --gecos "" "${AGENT_USER}"
fi

# === 2) Installer Node, npm, git, et dÃ©pendances de base si manquant ===
if ! command -v node >/dev/null 2>&1; then
  echo "ðŸ“¦ Installation Node.js (via NodeSource)..."
  # installer NodeJS 18.x (stable pour 24.04) : adapte si besoin
  curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
  apt-get update
  apt-get install -y nodejs git curl wget xz-utils unzip tar
fi

# === 3) CrÃ©er dossier agent, cloner repo, npm install ===
echo "ðŸ“¥ PrÃ©paration du dossier agent dans ${AGENT_DIR}..."
rm -rf "${AGENT_DIR}"
mkdir -p "${AGENT_DIR}"
chown "${AGENT_USER}:${AGENT_USER}" "${AGENT_DIR}"
chmod 750 "${AGENT_DIR}"

# Clonage en tant qu'utilisateur (Ã©vite fichiers root)
sudo -u "${AGENT_USER}" git clone "${REPO_URL}" "${AGENT_DIR}"

echo "ðŸ“¦ Installation des dÃ©pendances npm (en tant que ${AGENT_USER})..."
cd "${AGENT_DIR}"
sudo -u "${AGENT_USER}" bash -lc "npm install --no-audit --no-fund"

# === 4) Permissions sÃ»res ===
echo "ðŸ”§ RÃ©glage permissions (sÃ©curisÃ©)â€¦"
chown -R "${AGENT_USER}:${AGENT_USER}" "${AGENT_DIR}"
# droit d'exÃ©cution sur le rÃ©pertoire agent et lecture/Ã©criture pour owner
chmod -R 750 "${AGENT_DIR}"

# dossiers servers doivent Ãªtre Ã©crits par l'agent
mkdir -p "${AGENT_DIR}/servers"
chown -R "${AGENT_USER}:${AGENT_USER}" "${AGENT_DIR}/servers"
chmod -R 770 "${AGENT_DIR}/servers"

# === 5) Sudoers restreint pour l'utilisateur (NOPASSWD seulement sur commandes listÃ©es) ===
echo "âš–ï¸  CrÃ©ation sudoers restreint pour ${AGENT_USER}..."
{
  echo "# Sudoers restreint pour l'agent UniversellHub"
  printf "%s ALL=(ALL) NOPASSWD: " "${AGENT_USER}"
  # join commands with comma
  IFS=','; echo "${ALLOWED_CMDS[*]}"
} > "${SUDOERS_FILE}.tmp"

# safe place the file (validate with visudo)
visudo -cf "${SUDOERS_FILE}.tmp" >/dev/null 2>&1 || { echo "ERREUR: visudo check failed"; rm -f "${SUDOERS_FILE}.tmp"; exit 1; }
mv "${SUDOERS_FILE}.tmp" "${SUDOERS_FILE}"
chmod 440 "${SUDOERS_FILE}"

echo "âœ… sudoers restreint installÃ© : ${SUDOERS_FILE}"

# === 6) Systemd service file ===
SERVICE_FILE=/etc/systemd/system/agent-system.service
echo "âš™ï¸  CrÃ©ation du service systemd..."
cat > "${SERVICE_FILE}" <<EOF
[Unit]
Description=UniversellHub Agent
After=network.target

[Service]
User=${AGENT_USER}
Group=${AGENT_USER}
WorkingDirectory=${AGENT_DIR}
ExecStart=/usr/bin/node ${AGENT_DIR}/agent.js
Restart=always
RestartSec=5
Environment=NODE_ENV=production

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable --now agent-system.service

echo "âœ… Agent service dÃ©marrÃ© (systemctl status agent-system.service pour vÃ©rifier)."

# === 7) Fix final et infos ===
chown -R "${AGENT_USER}:${AGENT_USER}" "${AGENT_DIR}"
echo "ðŸ”Ž VÃ©rification: user et droits du dossier agent"
ls -ld "${AGENT_DIR}" "${AGENT_DIR}/servers" || true

echo "ðŸŽ‰ Installation terminÃ©e. Voir logs: sudo journalctl -u agent-system.service -f"
